import logging
import qrcode
from PIL import Image

def pil_to_zpl(image):
    """
    Converte uma imagem PIL (1-bit) para ZPL ^GF.
    """
    width, height = image.size
    row_bytes = (width + 7) // 8
    total_bytes = row_bytes * height
    data = bytearray()
    pixels = image.load()
    for y in range(height):
        byte = 0
        bits = 0
        for x in range(width):
            if pixels[x, y] == 0:  # preto
                byte |= (1 << (7 - bits))
            bits += 1
            if bits == 8:
                data.append(byte)
                byte = 0
                bits = 0
        if bits > 0:
            data.append(byte)
    hex_data = data.hex().upper()
    zpl = f"^GFA,{total_bytes},{total_bytes},{row_bytes},{hex_data}"
    return zpl

def gerar_zpl_ifood(order):
    """
    Gera o código ZPL para impressão de etiqueta de pedido iFood, incluindo QRCode dinâmico como imagem.
    """
    order_id = str(getattr(order, "order_id", "") or "")
    display_id = str(getattr(order, "display_id", "") or "")
    customer_name = str(getattr(getattr(order, "customer", None), "name", "") or "")
    order_amount = str(getattr(order, "order_amount", "") or "")

    delivery = getattr(order, "delivery", None)
    street = str(getattr(delivery, "address_street", "") or "")
    number = str(getattr(delivery, "address_number", "") or "")
    complement = str(getattr(delivery, "address_complement", "") or "")
    neighborhood = str(getattr(delivery, "address_neighborhood", "") or "")
    city = str(getattr(delivery, "address_city", "") or "")

    if not order_id:
        logging.error("order_id é obrigatório para gerar o ZPL.")
        raise ValueError("order_id é obrigatório para gerar o ZPL.")

    # --- QRCode dinâmico como imagem ^GF ---
    qr_data = f"https://lolla.pet/nfe/{order_id}"  # Exemplo de URL dinâmica para a nota fiscal
    qr = qrcode.QRCode(box_size=1, border=1)
    qr.add_data(qr_data)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white").convert('1')
    img = img.resize((180, 180), Image.NEAREST)  # 120x120px ~15mm em 203dpi
    zpl_qr = pil_to_zpl(img)

    zpl = f"""
^XA
^CI28
^PW800
^LL1200

^FO50,50
^FO40,40
^GFA,5000,5000,25,00000000000000000000000000000000000000000000000000
000000000000000000000000FF000000000000000000000000
0000000000000000000007FFFFFFE000000000000000000000
00000000000000000000FFFFFFFFFF00000000000000000000
0000000000000000001FFFFFFFFFFFF8000000000000000000
000000000000000000FFFFFFFFFFFFFF000000000000000000
000000000000000007FFFFFFFFFFFFFFF00000000000000000
00000000000000003FFFFFFFFFFFFFFFFC0000000000000000
0000000000000001FFFFFFFFFFFFFFFFFF8000000000000000
0000000000000007FFFFFFFFFFFFFFFFFFE000000000000000
000000000000001FFFFFFFFFFFFFFFFFFFFC00000000000000
000000000000007FFFFFFFFF007FFFFFFFFF00000000000000
00000000000001FFFFFFFC0000003FFFFFFFC0000000000000
00000000000007FFFFFF8000000001FFFFFFF0000000000000
0000000000001FFFFFF800000000000FFFFFF8000000000000
0000000000007FFFFF80000000000001FFFFFE000000000000
000000000000FFFFFC000000000000003FFFFF800000000000
000000000003FFFFF00000000000000007FFFFC00000000000
000000000007FFFF800000000000000001FFFFF00000000000
00000000001FFFFE0000000000000000007FFFF80000000000
00000000003FFFF80000000000000000001FFFFE0000000000
0000000000FFFFE000000000000000000007FFFF0000000000
0000000001FFFF8000000000000000000001FFFF8000000000
0000000003FFFE00000000000000000000007FFFC000000000
0000000007FFFC00000000000000000000001FFFF000000000
000000001FFFF000000000000000000000000FFFF800000000
000000003FFFE0000000000000000000000003FFFC00000000
000000007FFF80000000000000000000000001FFFE00000000
00000000FFFF000000000000000000000000007FFF00000000
00000001FFFC000000000000000000000000003FFF80000000
00000003FFF8000000000000000000000000001FFFC0000000
00000007FFF0000000000000000000000000000FFFE0000000
0000000FFFE00000000000000000000000000003FFF0000000
0000001FFF800000000000000000000000000001FFF8000000
0000003FFF000000000000000000000000000000FFFC000000
0000007FFE0000000000000000000000000000007FFE000000
0000007FFC0000000000000000000000000000003FFF000000
000000FFF80000000000000000000000000000001FFF800000
000001FFF00000000000000000000000000000000FFF800000
000003FFE000000000000000000000000000000007FFC00000
000007FFC000000000000000000000000000000003FFE00000
000007FF8000000000000000000000000000000001FFF00000
00000FFF8000000000000000000000000000000000FFF00000
00001FFF00000000000000000000000000000000007FF80000
00003FFE00000000000000000000000FC0000000007FFC0000
00003FFC00000000000000000000001FE0000000003FFC0000
00007FF800000000080000000000003FE0000000001FFE0000
00007FF8000000007E0000000000003FF0000000000FFF0000
0000FFF000000000FF8000000000007FF0000000000FFF0000
0001FFE000000001FFC00000000000FFF00000000007FF8000
0001FFC000000001FFC00000000000FFF80000000003FFC000
0003FFC000000003FFE00000000001FFF80000000003FFC000
0003FF8000000007FFF00000000001FFF80000000001FFE000
0007FF8000000007FFF00000000003FFFC0000000000FFE000
000FFF000000000FFFF80000000007FFFC0000000000FFF000
000FFE000000000FFFFC0000000007FFFC00000000007FF000
001FFE000000001FFFFC000000000FFFFE00000000003FF800
001FFC000000001FFFFE000000000FFBFE00000000003FF800
001FFC000000001FF7FE000000001FFBFE00000000001FFC00
003FF8000000003FE3FF000000001FF3FE00000000001FFC00
003FF8000000003FE1FF800000003FF1FF00000000000FFE00
007FF0000000007FE1FF800000003FE1FF00000000000FFE00
007FF0000000007FC0FFC00000007FE1FF000000000007FF00
00FFE0000000007FC0FFC00000007FC1FF000000000007FF00
00FFE000000000FFC07FE0000000FFC0FF800000000003FF00
00FFC000000000FF803FE0000000FF80FF800000000003FF80
01FFC000000000FF803FF0000001FF80FF800000000003FF80
01FF8000000001FF001FF0000003FF007F800000000001FF80
03FF8000000001FF001FF800001FFE007FC00000000001FFC0
03FF8000000001FF000FF80007FFFE007FC00000000000FFC0
03FF0000000001FF000FFC03FFFFFC007FC00000000000FFC0
03FF0000000003FE0007FEFFFFFFFC003FC00000000000FFE0
07FF0000000003FE0007FFFFFFFFF8003FE000000000007FE0
07FE0000000003FE0003FFFFFFFFF8003FE000000000007FE0
07FE0000000007FC0003FFFFFFFFF0003FE000000000007FF0
0FFE0000000007FC0001FFFFFFFFE0001FE000000000003FF0
0FFC0000000007FC0001FFFFFFF800001FF000000000003FF0
0FFC0000000007F80000FFFFFE0000001FF000000000003FF0
0FFC000000000FF80000FFFF800000001FF000000000003FF8
1FFC000000000FF800007FE0000000000FF000000000001FF8
1FF8000000000FF800007000000000000FF800001F80001FF8
1FF8000000001FF000000000000000000FF8001FFFF0001FF8
1FF8000000001FF000000000000000000FF81FFFFFF8001FF8
1FF8000000001FF0000000000000000007FFFFFFFFFC001FFC
1FF8000000001FF0000000000000000007FFFFFFFFFE000FFC
3FF0000000003FE0000000000000000007FFFFFFFFFE000FFC
3FF0000000003FE0000000000000000007FFFFFFFFFE000FFC
3FF0000000003FE0000000000000000007FFFFFFFFFF000FFC
3FF0000000003FE0000000000000000003FFFFFFFFFF000FFC
3FF0000000003FE0000000000000000003FFFFFE01FE000FFC
3FF0000000007FC0000000000000000003FFFFFC01FE000FFE
3FF0000000007FC0000000000000000003FC03FC01FE0007FE
3FF0000000007FC00000000000000000000007FC01FE0007FE
3FF0000000007FC00000000000000E00000007FC01FE0007FE
7FE000000000FFC00000000000001F00000007FC03FE0007FE
7FE000000000FF800000000700003F80000003FC03FE0007FE
7FE000000000FF800000000F80003FC0000003FE03FE0007FE
7FE000000000FF800000001FC0007FC0000003FF07FE0007FE
7FE000000000FF800000003FC0007FC0000003FFFFFE0007FE
7FE000000001FF800000003FE0007FC0000001FFFFFE0007FE
7FE000000001FF000000003FE0007FC0000001FFFFFE0007FE
7FE000000001FF000000003FE0003FC0000000FFFFFE0007FE
7FE000000001FF000000003FE0003F800000007FFFFE0007FE
7FE000000001FF000000003FE0001F800000003FFFFC0007FE
7FE000000003FF000000001FC0000E000000000FFFFC0007FE
7FE000000003FF000000000F8000000000000001FFFC0007FE
7FE000000003FE0000000007000000000000000007FC0007FE
3FF000000003FE0000000000000000000000000007FC0007FE
3FF000000003FE0000000000000000000000000007FC0007FE
3FF000000007FE0000000000000000000000000007FC0007FE
3FF000000007FE0000000000000000000000000007FC000FFC
3FF000000007FE0000000000000000000000000007FC000FFC
3FF000000007FC0000000000000000000000000007F8000FFC
3FF000000007FC0000000000000000000000000007F8000FFC
3FF00000000FFC0000000000000000000000000007F8000FFC
3FF80000000FFC000000000000000000000000000FF8000FFC
1FF80000000FFC000000000000000000000000000FF8000FFC
1FF80000000FFC000000000000000000000000000FF8001FFC
1FF80000000FF8000000000000000000000000000FF8001FF8
1FF80000000FF8000000000000000000000000000FF8001FF8
1FFC0000001FF8000000000000000000000000000FF8001FF8
0FFC0000001FF8000000000000000000000000000FF0003FF8
0FFC0000001FF8000000000000000000000000000FF0003FF0
0FFC0000001FF8000000000000000000000000001FF0003FF0
0FFE0000001FF0000000000000000000000000001FF0003FF0
07FE0000001FF0000000000000000000000000001FF0007FF0
07FE0000003FF0000000000000000000000000001FF0007FE0
07FE0000003FF0000000000000000000000000001FF0007FE0
07FF0000003FF0000000000000000000000000001FF000FFE0
03FF0000003FF0000000000000000000000000001FE000FFE0
03FF8000003FE0000000000000000000000000001FE000FFC0
03FF8000003FE0000000000000000000000000001FE001FFC0
01FF8000007FE0000000000000000000000000003FE001FFC0
01FFC000007FE0000000000000000000000000003FE001FF80
01FFC000007FE0000000000000000000000000003FE003FF80
00FFE000007FE0000000000000000000000000007FE003FF80
00FFE000007FC000000000000000000000000003FFE007FF00
007FE000007FC00000000000000000000000001FFFC007FF00
007FF000007FC0000000000000000000000001FFFFC00FFE00
007FF00000FFC000000000000000000000001FFFFF800FFE00
003FF80000FFC00000000000000000000001FFFFFF801FFC00
003FF80000FFC0000000000000000000001FFFFFFF001FFC00
001FFC0000FF8000000000000000000003FFFFFFFE003FFC00
001FFC0000FF80000000000000000000FFFFFFFFF8003FF800
000FFE0000FF80000000000000000001FFFFFFFF80007FF800
000FFF0000FF80000000000000000001FFFFFFFC00007FF000
0007FF0001FF80000000000000000001FFFFFFC00000FFF000
0007FF8001FF80000000000000000001FFFFFE000001FFE000
0003FF8001FF00000000000000000001FFFFE0000001FFC000
0003FFC001FF00000000000000000001FFFC00000003FFC000
0001FFE001FF00000000000000000001FFC000000007FF8000
0000FFE001FF00000000000000000001FF0000000007FF8000
0000FFF001FF00000000000000000001FF000000000FFF0000
00007FF803FF00000000000000000001FF000000001FFE0000
00007FFC03FE00000000000000000001FF000000001FFE0000
00003FFC03FE00000000000000000001FF000000003FFC0000
00001FFE03FE00000000000000000001FF000000007FF80000
00000FFF03FE00000000000000000001FF00000000FFF80000
00000FFF83FE00000000000000000001FF00000001FFF00000
000007FFC3FE00000000000000000001FF00000003FFE00000
000003FFE3FE00000000000000000000FF00000003FFE00000
000001FFF7FC00000000000000000000FF00000007FFC00000
000001FFFFFC00000000000000000000FF0000000FFF800000
000000FFFFFC00000000000000000000FF0000001FFF000000
0000007FFFFC00000000000000000000FF0000003FFE000000
0000003FFFFC00000000000000000000FF0000007FFC000000
0000001FFFFC00000000000000000000FF800001FFFC000000
0000000FFFF800000000000000000000FF800003FFF8000000
00000007FFF800000000000000000000FF800007FFF0000000
00000003FFF800000000000000000000FF80000FFFE0000000
00000001FFFC00000000000000000000FF80001FFFC0000000
00000000FFFE00000000000000000000FF80007FFF80000000
000000007FFF00000000000000000000FF8000FFFF00000000
000000003FFFC0000000000000000000FF8001FFFE00000000
000000001FFFE0000000000000000000FF8007FFF800000000
000000000FFFF8000000000000000000FF800FFFF000000000
0000000007FFFC000000000000000000FF803FFFE000000000
0000000003FFFF000000000000000000FF80FFFFC000000000
0000000000FFFFC000000000000000007F83FFFF8000000000
00000000007FFFF000000000000000007F8FFFFE0000000000
00000000003FFFFC00000000000000007FBFFFFC0000000000
00000000000FFFFF00000000000000007FFFFFF80000000000
000000000007FFFFC0000000000000007FFFFFE00000000000
000000000001FFFFF8000000000000007FFFFFC00000000000
000000000000FFFFFF00000000000000FFFFFF000000000000
0000000000003FFFFFE0000000000007FFFFFC000000000000
0000000000000FFFFFFC00000000003FFFFFF8000000000000
00000000000003FFFFFFE000000007FFFFFFE0000000000000
00000000000001FFFFFFFF800001FFFFFFFF80000000000000
000000000000007FFFFFFFFFFFFFFFFFFFFE00000000000000
000000000000000FFFFFFFFFFFFFFFFFFFF800000000000000
0000000000000003FFFFFFFFFFFFFFFFFFC000000000000000
0000000000000000FFFFFFFFFFFFFFFFFF0000000000000000
00000000000000001FFFFFFFFFFFFFFFF80000000000000000
000000000000000003FFFFFFFFFFFFFFC00000000000000000
0000000000000000007FFFFFFFFFFFFE000000000000000000
00000000000000000007FFFFFFFFFFE0000000000000000000
000000000000000000003FFFFFFFFC00000000000000000000
00000000000000000000007FFFFE0000000000000000000000
00000000000000000000000000000000000000000000000000
^FS

^A0N,80,70
^FO300,50^FDLollapet^FS

^A0N,30,30
^FO300,140^FDGostou? Sua avaliação com 5 estrelas^FS
^A0N,30,30
^FO300,190^FDno iFood nos ajuda muito! ♥♥^FS

^A0N,40,35
^FO40,330^FDPEDIDO^FS
^A0N,40,30
^FO40,400^FDCódigo: {display_id}^FS
^A0N,40,30
^FO40,460^FDTotal: R$ {order_amount}^FS
^FO40,530^GB720,3,3^FS
^A0N,40,35
^FO40,570^FDENTREGA^FS
^A0N,40,30
^FO40,640^FDCliente: {customer_name}^FS
^A0N,40,30
^FO40,700^FDEndereço: {street}^FS
^A0N,40,30
^FO40,760^FDNúmero: {number}^FS
^A0N,40,30
^FO40,820^FDComplemento: {complement}^FS
^A0N,40,30
^FO40,880^FDBairro: {neighborhood}^FS
^A0N,40,30
^FO40,940^FDCidade: {city}^FS

^FO550,900
{zpl_qr}

^XZ
"""
    return zpl.strip()